<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<title>ICNS Viewer</title>
	<style>
		html,
		body {
			margin: 0;
			padding: 0;
			overflow: hidden;
		}

		#viewer {
			pointer-events: none;
			object-fit: contain;
			object-position: center;
			width: 100%;
			height: 100%;
			max-width: 100vw;
			max-height: 100vh;
		}
	</style>
</head>

<body>
	<img id="viewer" />
	<script>
		// åˆ›å»ºä¸€ä¸ªURLSearchParamså¯¹è±¡ï¼Œç”¨äºè§£æURLä¸­çš„æŸ¥è¯¢å‚æ•°
		const urlParams = new URLSearchParams(window.location.search);
		// ä»æŸ¥è¯¢å‚æ•°ä¸­è·å–æ–‡ä»¶è·¯å¾„
		const filePath = urlParams.get('path');
		// ä»æŸ¥è¯¢å‚æ•°ä¸­è·å–å®½åº¦
		const width = urlParams.get('width');
		// ä»æŸ¥è¯¢å‚æ•°ä¸­è·å–é«˜åº¦
		const height = urlParams.get('height');
		// ä»æŸ¥è¯¢å‚æ•°ä¸­è·å–ä¸»é¢˜
		const theme = urlParams.get('theme');
		// ä»æŸ¥è¯¢å‚æ•°ä¸­è·å–è¯­è¨€
		const lang = urlParams.get('lang');

		// é€šè¿‡IDé€‰æ‹©å™¨è·å–HTMLä¸­çš„viewerå…ƒç´ 
		const viewer = document.querySelector('#viewer');

		// 1. é¦–å…ˆåŠ è½½ç¼©ç•¥å›¾
		// ğŸ‘ é¿å…åŠ è½½æ—¶é—´è¿‡é•¿ï¼ŒUIæ— å†…å®¹
		// å°†æ–‡ä»¶è·¯å¾„ä¸­çš„".d5a"æ›¿æ¢ä¸º"_thumbnail.png"ï¼Œå¹¶è®¾ç½®ä¸ºviewerçš„src
		viewer.src = filePath.replace(".d5a", "_thumbnail.png");

		// 2. åŠ è½½æ–‡ä»¶å¹¶æ›¿æ¢ç¼©ç•¥å›¾
		// ä½¿ç”¨è‡ªæ‰§è¡Œçš„å¼‚æ­¥å‡½æ•°
		(async function () {
			// å¼•å…¥AdmZipåº“ï¼Œç”¨äºå¤„ç†zipæ–‡ä»¶
			const AdmZip = require('adm-zip');
			// å¼•å…¥fsåº“ï¼Œç”¨äºæ–‡ä»¶ç³»ç»Ÿæ“ä½œ
			const fs = require('fs');

			// è§£å‹.d5aæ–‡ä»¶
			let zip = new AdmZip(filePath);
			// è·å–zipæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ¡ç›®
			let zipEntries = zip.getEntries();

			// åœ¨zipæ¡ç›®ä¸­æ‰¾åˆ°åä¸º'icon.png'çš„æ–‡ä»¶
			let iconEntry = zipEntries.find(entry => entry.entryName === 'icon.png');
			// å¦‚æœæ²¡æœ‰æ‰¾åˆ°'icon.png'ï¼Œåˆ™åœ¨æ§åˆ¶å°è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶è¿”å›
			if (!iconEntry) {
				console.error(`icon.png not found in .d5a file.`);
				return;
			}

			// å°†'icon.png'æ–‡ä»¶æå–åˆ°ä¸€ä¸ªbufferä¸­
			let buffer = iconEntry.getData();

			// å°†bufferè½¬æ¢ä¸ºbase64æ ¼å¼
			let base64 = `data:image/png;base64,${buffer.toString('base64')}`;

			// å°†viewerçš„srcè®¾ç½®ä¸ºbase64å­—ç¬¦ä¸²ï¼Œå³æ˜¾ç¤º'icon.png'å›¾ç‰‡
			viewer.src = base64;
		})();	
		</script>
</body>

</html>